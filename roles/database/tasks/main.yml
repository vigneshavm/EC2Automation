- name: "Get public IP address for Database"
  command: curl http://169.254.169.254/latest/meta-data/public-ipv4
  register: DBInstanceIP

- name: "Set fact on localhost"
  set_fact:
    launched_DBInstanceIP: "{{ DBInstanceIP.stdout }}"

- name: "Copy fact to other servers"
  set_fact:
    launched_DBInstanceIP: "{{ launched_DBInstanceIP }}"
  delegate_to: "{{ item }}"
  delegate_facts: True
  with_items: "{{ groups['all'] }}"
  when: item != "localhost"

- name: "Add MongoDB depenencey"
  become: true
  become_user: root
  command: apt-key adv --keyserver keyserver.ubuntu.com --recv 7F0CEB10


- name: "MongoDB | Add  repository"
  become: true
  become_user: root
  shell:
    echo 'deb http://downloads-distro.mongodb.org/repo/ubuntu-upstart dist 10gen' | sudo tee /etc/apt/sources.list.d/mongodb.list

- name: Update system
  become: true
  become_user: root
  command: apt-get update

- name: "MongoDB Installation"
  become: true
  become_user: root
  command: apt-get --assume-yes install -y mongodb-org

#- name: "copy private file from template"
#  become: true
#  become_user: root
#  template: src=mongoEnable
#            dest=/etc/mongod.conf
#            mode=0600


- name: "copy private file from template"
  become: true
  become_user: root
  template: src=mongoFile
            dest=/etc/systemd/system/mongodb.service
            mode=0600

- name: "Copy fact to other servers"
  become: true
  become_user: root
  command: systemctl start mongodb

- name: "mongodb enable"
  become: true
  become_user: root
  command: systemctl enable mongodb


- name: "Creates directory"
  file: path=/home/ubuntu/neoData state=directory

- name: "copy neo database file"
  become: true
  become_user: root
  unarchive: src=neo.tar.gz
            dest=/home/ubuntu/neoData

- name: "copy neoHome database file"
  become: true
  become_user: root
  unarchive: src=neoHome.tar.gz
            dest=/home/ubuntu/neoData

- name: "mongo restore neo database"
  command: "mongorestore --port 27017 --db neo /home/ubuntu/neoData/neo"

- name: "mongo restore neoHome database"
  command: "mongorestore --port 27017 --db neo /home/ubuntu/neoData/neoHome"
